import {useMemo, useState, useRef} from 'react'
import './App.css'
import {t, type Locale} from './i18n/locale'
import {createGidTypes} from "./segments/Segments.ts";
import * as Helpers from "./utils/Helpers.ts";
import Table from "@/components/Table.tsx";
import Modal from "@/components/Modal.tsx";


type Segment = {
  key: string;
  label: string;
  value: string;
  inpValue: string;
  isValid: boolean;
  isPadding: boolean;
};


function parseCsv(csvText: string): string[][] {
  const rows: string[][] = [];
  let row: string[] = [];
  let field = "";
  let inQuotes = false;

  for (let i = 0; i < csvText.length; i++) {
    const c = csvText[i];
    const next = csvText[i + 1];

    if (c === '"') {
      // Escaped quote ("")
      if (inQuotes && next === '"') {
        field += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }

    if (!inQuotes && (c === ";" || c === '\t')) {
      row.push(field);
      field = "";
      continue;
    }

    if (!inQuotes && (c === "\n" || c === "\r")) {
      if (c === "\r" && next === "\n") i++;
      row.push(field);
      field = "";
      rows.push(row);
      row = [];
      continue;
    }
    field += c;
  }

  // last field
  row.push(field);
  rows.push(row);

  // Remove trailing empty row (common if file ends with newline)
  if (rows.length && rows[rows.length - 1].every(v => v === "")) rows.pop();

  return rows;
}


function App() {
  const [lang, setLang] = useState<Locale>("en")
  const [settingsModal, setSettingsModal] = useState<boolean>(false)
  const inputRef = useRef<HTMLInputElement | null>(null);

  //9010123000000000
  //9031123123412345
  //9012123123410000
  const [value, setValue] = useState('')
  const gidTypes = useMemo(() => createGidTypes(lang), [lang]);

  const gidResult = useMemo(() => {
    const prefix = Helpers.getPrefixFromStr(value);
    const result = Helpers.getGidTypeFromPrefix(gidTypes, prefix);
    const type = Object.keys(result)[0] ?? false;

    if (!type) return null;

    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
    // @ts-expect-error
    const gidType = result[type];
    const segmentedResult = Helpers.getSegmentedResult(lang, gidType.layout, value);

    return {gidType, segmentedResult};
  }, [value, gidTypes, lang]);


  const openSettingsModal = () => {
    setSettingsModal(true);
  };

  const closeSettingsModal = () => {
    setSettingsModal(false);
  };

  const onPickClick = () => inputRef.current?.click();

  const onFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    if (file.type !== "text/csv") {
      alert("Wrong file type");
    }
    const text = await file.text();


    console.log(parseCsv(text));


    // allow selecting the same file again later
    e.target.value = "";
  };


  return (
    <>

      <Modal open={settingsModal} onClose={closeSettingsModal}>
        <button type="button" onClick={onPickClick}>
          Choose CSV
        </button>
        <input
          ref={inputRef}
          type="file"
          accept=".csv,text/csv"
          onChange={onFileChange}
          style={{display: "none"}}
        />
      </Modal>

      <header id={"header"} className={"flex border-bottom"}>
        <figure id={"logo"} className={"mr-10"}>
          <svg xmlns="http://www.w3.org/2000/svg" width="200" height="42" fill="none" viewBox="0 0 218 46">
            <path className={"light:text-black dark:text-white"} fill="currentColor"
                  d="M57.148 30.724a.306.306 0 0 1-.301-.3V16.6c0-.162.139-.3.301-.3h2.736c.093 0 .186.046.255.115l5.333 8.192v-8.007c0-.162.14-.3.302-.3h2.852c.162 0 .301.138.301.3v13.823c0 .161-.139.3-.301.3H65.89a.37.37 0 0 1-.255-.116l-5.31-8.146v7.962c0 .161-.14.3-.302.3zm21.565 0c-1.392 0-2.667-.324-3.78-.97-1.136-.646-2.04-1.569-2.713-2.677-.65-1.13-.974-2.423-.974-3.807 0-1.362.325-2.631.974-3.762.672-1.13 1.554-2.03 2.69-2.677 1.136-.646 2.411-.969 3.803-.969 1.368 0 2.643.323 3.78.97a7.1 7.1 0 0 1 2.689 2.676c.672 1.13.997 2.4.997 3.762 0 1.384-.325 2.654-.997 3.784a7.35 7.35 0 0 1-2.69 2.7c-1.136.646-2.411.97-3.78.97m.046-3.324a3.47 3.47 0 0 0 1.855-.53 3.73 3.73 0 0 0 1.368-1.5c.348-.623.51-1.339.51-2.1 0-.739-.162-1.454-.51-2.077a3.8 3.8 0 0 0-1.368-1.477 3.47 3.47 0 0 0-1.855-.53 3.63 3.63 0 0 0-1.901.53 3.94 3.94 0 0 0-1.415 1.477 4.3 4.3 0 0 0-.51 2.077c0 .761.162 1.477.51 2.1.371.623.835 1.13 1.415 1.477.58.369 1.205.553 1.9.553m10.017 3.324c-.162 0-.278-.139-.278-.3V16.6c0-.162.116-.3.278-.3h5.68c1.763 0 3.154.438 4.128 1.338 1.438 1.292 1.925 3.738 1.23 5.538a4.1 4.1 0 0 1-1.253 1.685c-1.878 1.454-4.22 1.315-6.47 1.315v4.247c0 .161-.138.3-.3.3zm3.316-7.754s2.921.323 3.942-.346c.394-.254.626-.877.626-1.339a1.87 1.87 0 0 0-.696-1.361c-.44-.37-1.53-.485-2.087-.485l-1.785.046zm13.449 7.754c-.163 0-.279-.139-.279-.3V19.53h-3.176c-.163 0-.302-.115-.302-.277V16.6c0-.161.139-.3.302-.3h9.947a.29.29 0 0 1 .301.3v2.654c0 .162-.115.277-.301.277h-3.177v10.893c0 .161-.139.3-.301.3zm9.414 0a.306.306 0 0 1-.302-.3V16.6c0-.162.139-.3.302-.3h3.014c.162 0 .302.138.302.3v13.823c0 .161-.14.3-.302.3zm11.825.138a9 9 0 0 1-3.292-.623 8.9 8.9 0 0 1-2.806-1.662.32.32 0 0 1-.07-.346l.812-2.746c.046-.092.116-.162.209-.162a.26.26 0 0 1 .255.07c1.229 1.154 2.62 2.192 4.359 2.284.464.023.974.047 1.414-.092 1.369-.438.789-1.823-.231-2.238q-.522-.208-1.461-.485c-.928-.254-1.693-.53-2.273-.808-.626-.277-1.159-.715-1.623-1.292-.44-.6-.672-1.385-.672-2.33q0-1.35.695-2.355a4.4 4.4 0 0 1 1.925-1.546c.812-.346 1.762-.53 2.829-.53a9 9 0 0 1 2.806.438c.904.277 1.715.67 2.434 1.13.116.093.163.232.093.37l-.765 2.585c-.023.092-.093.138-.186.161a.28.28 0 0 1-.232-.023c-1.043-.646-2.086-1.43-3.315-1.592-.812-.116-2.041-.07-2.319.9-.348 1.246 1.484 1.569 2.319 1.823q1.39.416 2.295.83c.626.3 1.183.762 1.623 1.339.464.6.696 1.408.696 2.377 0 .946-.255 1.754-.742 2.446-.464.692-1.136 1.2-1.971 1.57a7.7 7.7 0 0 1-2.806.507m20.289 0a9 9 0 0 1-3.292-.623 8.9 8.9 0 0 1-2.806-1.662.32.32 0 0 1-.069-.346l.811-2.746c.046-.092.116-.162.209-.162a.26.26 0 0 1 .255.07c1.229 1.154 2.62 2.192 4.359 2.284.464.023.974.047 1.415-.092 1.368-.438.788-1.823-.232-2.238q-.522-.208-1.461-.485c-.928-.254-1.693-.53-2.272-.808-.627-.277-1.16-.715-1.624-1.292-.44-.6-.672-1.385-.672-2.33q0-1.35.696-2.355a4.4 4.4 0 0 1 1.924-1.546c.812-.346 1.762-.53 2.829-.53a9 9 0 0 1 2.806.438c.904.277 1.716.67 2.434 1.13.116.093.163.232.093.37l-.765 2.585c-.023.092-.093.138-.186.161a.27.27 0 0 1-.231-.023c-1.044-.646-2.087-1.43-3.316-1.592-.812-.116-2.041-.07-2.319.9-.348 1.246 1.484 1.569 2.319 1.823q1.39.416 2.295.83c.626.3 1.183.762 1.623 1.339.464.6.696 1.408.696 2.377 0 .946-.255 1.754-.742 2.446-.464.692-1.136 1.2-1.971 1.57a7.7 7.7 0 0 1-2.806.507m11.362-.138c-.162 0-.278-.139-.278-.3V19.53h-3.177c-.162 0-.301-.115-.301-.277V16.6c0-.161.139-.3.301-.3h9.948c.185 0 .301.139.301.3v2.654c0 .162-.116.277-.301.277h-3.177v10.893c0 .161-.139.3-.301.3zm15.165 0c-1.252 0-2.156-.254-3.107-.762-.928-.508-1.67-1.223-2.18-2.17-.51-.922-.765-2.03-.765-3.3V16.37c0-.162.139-.277.301-.277h3.015c.162 0 .278.115.278.277v8.123c0 .923.255 1.638.742 2.146s.928.761 1.739.761c.812 0 1.229-.253 1.693-.738.464-.508.696-1.246.696-2.17V16.37c0-.162.139-.277.301-.277h3.014c.163 0 .302.115.302.277v8.123c0 1.269-.255 2.377-.765 3.3-.487.946-1.229 1.661-2.157 2.169s-1.855.762-3.107.762m8.649 0a.29.29 0 0 1-.301-.3V16.6c0-.162.115-.3.301-.3h5.264c1.391 0 2.666.3 3.779.923a6.44 6.44 0 0 1 2.597 2.561c.603 1.085.928 2.33.928 3.715 0 1.408-.325 2.654-.951 3.739a6.4 6.4 0 0 1-2.643 2.561c-1.113.624-2.412.924-3.826.924zm3.293-3.231h2.04c.673 0 1.299-.162 1.832-.485a3.6 3.6 0 0 0 1.275-1.408c.302-.6.464-1.292.464-2.077 0-.761-.162-1.476-.487-2.076a3.6 3.6 0 0 0-1.322-1.431 3.77 3.77 0 0 0-1.901-.508h-1.901zm11.895 3.23a.307.307 0 0 1-.302-.3V16.602c0-.162.14-.3.302-.3h3.014c.163 0 .302.138.302.3v13.823c0 .161-.139.3-.302.3zm13.101 0c-1.391 0-2.667-.323-3.78-.969-1.136-.646-2.04-1.569-2.713-2.677-.649-1.13-.974-2.423-.974-3.807 0-1.362.325-2.631.974-3.762.673-1.13 1.554-2.03 2.69-2.677 1.136-.646 2.412-.969 3.803-.969 1.368 0 2.643.323 3.779.97a7.1 7.1 0 0 1 2.69 2.676c.673 1.13.997 2.4.997 3.762 0 1.384-.324 2.654-.997 3.784a7.34 7.34 0 0 1-2.69 2.7c-1.136.646-2.411.97-3.779.97m.046-3.323c.673 0 1.299-.184 1.855-.53a3.73 3.73 0 0 0 1.368-1.5c.348-.623.51-1.339.51-2.1 0-.739-.162-1.454-.51-2.077a3.8 3.8 0 0 0-1.368-1.477 3.47 3.47 0 0 0-1.855-.53 3.63 3.63 0 0 0-1.901.53 3.94 3.94 0 0 0-1.415 1.477 4.3 4.3 0 0 0-.51 2.077c0 .761.163 1.477.51 2.1.371.623.835 1.13 1.415 1.477a3.45 3.45 0 0 0 1.901.553"/>
            <path fill="#a9113f"
                  d="M40.908 0H5.313C2.379 0 0 2.367 0 5.287v35.426C0 43.633 2.379 46 5.313 46h35.595c2.934 0 5.313-2.367 5.313-5.287V5.287c0-2.92-2.379-5.287-5.313-5.287"/>
            <path fill="#fff"
                  d="M21.317 11.911c-5.357 1.707-8.473 7.902-6.526 12.936.78 1.936 1.948 3.097 3.896 4.259 1.948 1.161 4.285 1.161 6.233.378 1.957-.766 3.515-2.701 3.515-4.637-.39-1.162 0-2.324-.779-3.098-.78-.387-1.169-1.936-2.337-1.549.779 1.936 1.558 3.485.39 5.421-1.56 1.945-4.286 1.945-6.243 1.162-1.169-.775-1.558-1.936-2.337-3.098-.78-1.936-.78-3.872.39-5.808a9.2 9.2 0 0 1 3.506-3.097c1.168-.387 2.337-1.162 3.506-1.162 6.242-.387 11.306 5.808 10.137 12.003-.39 2.323-1.169 4.268-2.727 5.808q-1.753 2.334-4.675 3.493c-1.558.379-3.116 1.162-4.674 1.162-1.948-.387-3.896-.387-5.844-1.162a484 484 0 0 1-3.515-2.332c-1.948-1.936-3.506-3.872-4.285-6.582-.78-1.54-.39-3.097-.39-4.646-.39-4.646 1.559-8.905 5.454-11.616 5.454-3.097 11.696-3.872 17.15-.774 2.337 1.549 3.896 3.485 5.844 5.42.779 1.162 1.558 2.71 1.947 4.26-2.727-6.583-9.35-11.229-16.76-10.067-3.506.774-6.233 2.314-8.57 5.033q-1.753 2.324-2.338 4.646a20.9 20.9 0 0 0 0 6.97c.78 2.71 2.338 5.033 4.675 6.582 1.558.774 3.117 1.549 4.675 1.936h3.896c2.337-.387 4.285-1.549 5.843-3.098 2.727-2.323 2.727-6.195 2.338-9.3-.77-2.315-1.94-3.864-4.277-5.026-1.558-.774-3.116-1.161-5.064-.774-1.178.387-2.346.774-3.126 1.549-.779 1.161-1.948 2.323-1.948 3.872 0 .774.39 1.936.78 2.71 1.168 1.162 2.346 2.323 4.294 1.549-1.948-2.323-4.285-5.808 0-6.97 3.506-.774 7.012 1.936 7.012 5.421 0 1.549-.39 3.098-1.169 4.26-1.177 1.944-3.506 2.718-5.463 3.484-1.947.387-3.895 0-5.454-.774-1.558-.775-2.727-1.937-3.895-3.098-1.169-1.936-1.948-3.872-1.948-6.204 0-3.485 1.558-6.582 4.285-8.905 1.558-1.549 3.506-1.936 5.454-2.71 3.126-.388 6.242 0 8.97 1.161 6.622 3.494 9.738 12.012 6.622 18.99-1.558 3.485-4.285 6.195-7.402 7.744-4.675 1.936-10.518 1.936-15.202-.775-5.064-3.097-7.791-8.14-8.181-13.56 0-1.549.39-2.71.78-4.26-1.949 7.745 3.125 15.884 10.907 17.812 1.948.387 3.896.774 5.852.387 2.338-.388 4.286-1.162 6.233-2.323 2.338-1.936 3.896-4.26 5.065-6.979.779-1.936 1.169-3.871.779-5.807-.39-2.315-.78-4.638-2.727-6.574-2.337-1.936-4.675-3.872-7.756-3.986-1.576-.185-3.16-.053-4.816.343"/>
          </svg>
        </figure>
        <button onClick={openSettingsModal}>set</button>
        <button className={"ml-auto"}
                onClick={() => setLang((lang === "en") ? "sv" : "en")}>{lang.toUpperCase()}</button>
      </header>

      <main>
        <div className="wrapper max-w-lg">
          <div className="card">

            <h1 className={"headline-2 mb-6"}>{t(lang, 'title', 'GID Inspector')}</h1>
            <div className="mb-6">
              <label htmlFor="inp-gid">GID</label>
              <input
                id={"inp-gid"}
                type="text"
                placeholder={"Fill in GID number"}
                onChange={(e) => setValue(e.target.value)}
                value={value}
              />
            </div>

            {gidResult && (
              <div>
                <h2 className={"headline-4 mb-2"}>{gidResult.gidType.label}</h2>
                <Table segments={gidResult.segmentedResult as Segment[]}></Table>
              </div>
            )}
          </div>
        </div>
      </main>
    </>
  )
}

export default App
